; ГРС Кушнаренково
; 06.2024 - Галеев
; регулирование Pвых газа (КРПБ, контур САУ) +проверка клапана на бп

#include "eval.lib\set.evl"
#include "eval.lib\klap_test.evl"

func checkPrecond(dummy)
  x=0
  if (ne({РЕЖИМ ГРС КУШН},0)&ne({КР БАЙП КУШН},2))
    x=x|eq({КОНТР РЕГ КУШН},1)		; работа только на эр-03
  endif
  return(x)
endfunc

; mode  - 0-ручной; 1-автомат
func pid(id,ki,kp,ref,pos,fdb,fdbtrust,mode)
  return(pidreg(id,ki,kp,0.1,ref,pos,fdb,0,0,100,10,0,0.05,mode,4,1,0,2,0,fdbtrust))
endfunc


; переменные
; 1-30 рег
; 31 - режим рег
; 32 - сигнал упр
; 33 - неисправн крбп
;
func oninit(t)
  bpticks=0
  aout[32]=0
  dout[33]=0	; исправн крбп
  prevhour=curhour(0)
  sleep(5*18)
endfunc



;
; хотя при контуре эр-04 регулятор сау не работает, делаем ради корректного начения переменных
; расчет управления конт сау делается постоянно, вдруг при переходе на бп сразу придется работать
;
mode=checkPrecond(0)
dout[31]=mode
u=pid(1,{ПИДСАУ КИ КУШН},{ПИДСАУ КП КУШН},{РВЫХ ЗАД КУШН},{ПОЗ ЗАДВ КУШН},{РВЫХ 123 КУШН},dost(РВЫХ 123 КУШН),mode)

; При работе не на БП изменение "зад полож" приводит к перемещению крана-рег
; если руч режим на бп, сигнал ф-ии pid будет равен текущему положению, ду в это время также блокируется
;
if (eq({КОНТР РЕГ КУШН},1))

  ; сигнал управления для отработки алг ду (контур САУ)
  ;
  u=klap_test(u,{U РУЧ КРБ КУШН},{ПОЗ ЗАДВ КУШН},33,{КР БАЙП КУШН},6,{РЕЖИМ ГРС КУШН})
  aout[32]=u
  x=setSens({РУЧ БП04 КУШН}[sys_num],u,0.1)

else

  if (eq({РЕЖ РЕГ04 КУШН},0)) ; тест бп при контуре эр-04 не на бп
                             ; и перемещение вслед за руч пол
    u={U РУЧ КРБ КУШН}
    u=klap_test(u,{U РУЧ КРБ КУШН},{ПОЗ ЗАДВ КУШН},33,{КР БАЙП КУШН},6,{РЕЖИМ ГРС КУШН})
    aout[32]=u
    x=setSens({РУЧ БП04 КУШН}[sys_num],u,0.1)

  endif
endif




